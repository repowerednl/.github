name: Build (& deploy) sphinx documentation (UV)

on:
  workflow_call:
    inputs:
      uv_version:
        type: string
        required: true
      tag:
        description: "The Semantic Versioning GitHub tag used for version control"
        type: string
        required: true
      docs_target:
        description: "The directory where the package's documentation will be deployed (e.g. /home/repowered/docs/<package name>/). Skips deployment if empty (Sphinx build testing)."
        type: string
        default: '/home/repowered/docs/<package-name>'

      # Optional
      docs_host:
        type: string
        default: docs.repowered.nl
      docs_port:
        type: number
        default: 22
      docs_user:
        type: string
        default: repowered
      docs_source:
        type: string
        default: docs/_build/html

    secrets:
      private_pypi_user:
        required: true
      private_pypi_password:
        required: true
      docs_ssh_private_key:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

      - name: UV and Python Setup
        uses: repowerednl/.github/composite-actions/python-uv-cache@main
        with:
          uv_version: ${{ inputs.uv_version }}
          private_pypi_user: ${{ secrets.private_pypi_user }}
          private_pypi_password: ${{ secrets.private_pypi_password }}
          enable_cache: true

      - name: Checkout .github repo for default docs folder
        uses: actions/checkout@v5
        with:
          repository: repowerednl/.github
          ref: DATA-323-Create-default-Sphinx-docs-folder-and-store-it-somewhere
          path: /tmp/gh-shared

      - name: Fetch "docs/" folder from shared .github repo & copy missing files
        run: |  # Makedir 'docs' if it doesnt exist (-p) & copy only missing files (--archive & --verbose: -av)
          mkdir -p docs
          rsync -av --ignore-existing /tmp/gh-shared/configuration-files/sphinx-docs/docs/ ./docs/

      - name: Build documentation for ${{ github.event.repository.name }} version ${{ inputs.tag }}
        run: |
          cd docs
          uv run python pre.py --logging=info
          uv run make html --logging=info
          uv run python post.py --logging=info

      - if: ${{ (inputs.docs_target != '/home/repowered/docs/<package-name>') && (inputs.docs_target != '') }} # Only deploy if docs_target is not default or empty
        name: Deploy documentation to server (${{ inputs.docs_target }})
        uses: appleboy/scp-action@v1
        with:
          host: ${{ inputs.docs_host }}
          port: ${{ inputs.docs_port }}
          username: ${{ inputs.docs_user }}
          key: ${{ secrets.docs_ssh_private_key }}
          source: ${{ inputs.docs_source }}
          target: ${{ inputs.docs_target }}
          strip_components: 3 # remove the docs/_build/html part from the path
