name: Hotfix Patch Tag Check

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
    branches:
      - main
      - 'IN-220-**'  # Temporary: for testing purposes
  workflow_dispatch:  # Allows manual testing from Actions tab

jobs:
  check-patch-tag:
    runs-on: ubuntu-latest
    if: contains(github.head_ref, 'hotfix')
    
    steps:
      - name: Auto-add #patch tag to PR description
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            const hasPatchTag = prBody.includes('#patch');
            
            if (!hasPatchTag) {
              // Add #patch to the PR description
              const updatedBody = prBody ? `${prBody}\n\n#patch` : '#patch';
              
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                body: updatedBody
              });
              
              // Add a comment to inform
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '✅ **#patch tag automatically added**\n\n' +
                      'This hotfix PR was missing the `#patch` tag in the description.\n\n' +
                      'The tag has been automatically added to ensure proper versioning.'
              });
              
              console.log('✅ #patch tag added automatically to PR description');
            } else {
              console.log('✅ #patch tag already present in PR description');
            }